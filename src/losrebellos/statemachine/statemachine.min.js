/*
 *
 * @author Benoit Vinay
 *
 * ben@benoitvinay.com
 * http://www.benoitvinay.com
 *
 */

 var losrebellos=losrebellos||{};losrebellos.State=(function(){function a(b,d){this.name=b;this.entering=d.entering;this.exiting=d.exiting;this.transitions={};this.command=d.command;for(var c in d.transitions){this.defineTransition(c,d.transitions[c])}}a.prototype.defineTransition=function(b,c){this.transitions[b]=c};a.prototype.removeTransition=function(b){if(this.transitions[b]!==undefined){delete this.transitions[b]}};a.prototype.removeTransitionByTargettedState=function(c){for(var b in this.transitions){if(c===this.transitions[b]){delete this.transitions[b]}}};return a})();losrebellos.StateMachine=(function(){function a(f){if(f){for(var g in f){this[g]=f[g]}}this.started=false;this.initialState;this.previousState;this.currentState;this.currentData;this.states={}}a.prototype.start=function(f){if(this.started){console.log("- statemachine is already started: ",this.currentState);return}console.log("- statemachine started: ",this.initialState);this.onStart(this.initialState,f);c(this,this.initialState,f);this.started=true};a.prototype.stop=function(){if(!this.started){console.log("- statemachine is not started");return}this.onStop(this.currentState,this.currentData);this.started=false;console.log("- statemachine stopped")};a.prototype.registerState=function(g,f){if(this.states[g.name]!==undefined){return false}this.states[g.name]=g;if(f){this.initialState=g}return true};a.prototype.removeState=function(h){var g;for(var f in this.states){var g=this.states[f];g.removeTransitionByTargettedState(h)}if(this.states[h]!==undefined){delete this.states[h];return true}return false};a.prototype.onAction=function(g,f){if(!e){d.push({action:g,data:f});return}var i=this.currentState.transitions[g];var h=this.states[i];if(i!==undefined&&h!==undefined&&this.currentState.name!==h.name){c(this,h,f)}};var c=function(f,h,g){e=false;if(f.currentState!==undefined&&f.currentState.exiting!==undefined){f.onExiting(f.currentState)}if(h.entering!==undefined){f.onEntering(h)}f.previousState=f.currentState;f.currentState=h;f.currentData=g;f.onStateChanged(h,g);if(h.command!==undefined&&h.command!==""){f.onCommand(h,g)}e=true;b(f)};a.prototype.forceTransition=function(g,f){c(this,this.states[g],f)};var e=true;var d=[];var b=function(f){if(d!==undefined&&d.length>0){var g=d.shift();var h=f.currentState.transitions[g.action];if(h===undefined){b(f)}else{f.onAction(g.action,g.data)}}};a.prototype.onCommand=function(h,g){var f=window[this.currentState.command];var i=new f();i.execute.apply(this,[this,h,g]);delete i};return a})();losrebellos.StateMachineInjector=(function(){function a(b){this.fsm=b}a.prototype.inject=function(b){if(this.fsm.initial===undefined){console.log("You need an initial state in your fsm.")}var d=0;var e;for(var c in this.fsm.states){e=new losrebellos.State(c,this.fsm.states[c]);b.registerState(e,(this.fsm.initial===e.name));d++}console.log("- "+d+" states: ",b.states)};return a})();losrebellos.fsmFactory=function(e,d,c){var b=new (c||losrebellos.StateMachine)(d);var a=new losrebellos.StateMachineInjector(e);a.inject(b);return b};